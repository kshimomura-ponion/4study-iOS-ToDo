name: Swift

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_xcode:

    runs-on: macos-latest
    env:
      IPA_OUTPUT_PATH: ${{ format('{0}/Build.ipa', github.workspace) }}
      
    steps:
      - uses: actions/checkout@v2
      - name: Cache CocoaPods files
        uses: actions/cache@v1
        with:
          path: Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-
      - run: pod install
      - name: Build
        run: xcodebuild -workspace RealmToDo.xcworkspace -scheme RealmToDo -configuration Debug -sdk iphonesimulator
        
      - uses: actions/upload-artifact@v2
        with:
          name: Build-iOS-ipa
          path: ${{ env.IPA_OUTPUT_PATH }}

      - name: Cleanup
        if: always()
        uses: geekyeggo/delete-artifact@v1
        with:
          name: Build-iOS
          
  upload_deploygate:
    name: Upload ipa to DeployGate
    runs-on: ubuntu-latest
    needs: build_xcode

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v2
        with:
          name: Build-iOS-ipa
      - name: Distribute App
        run: |
          curl \
          -H "Authorization: token ${{secrets.DEPLOY_GATE_API_KEY}}" \
          -F "file=@Build.ipa" \
          -F "message=${{github.event.pull_request.title}}
          ${{github.event.pull_request.body}}" \
          "https://deploygate.com/api/users/${{secrets.DEPLOY_GATE_USER_NAME}}/apps"
